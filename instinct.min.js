/**
  * instinct.js (c) 2009-2013 Ziggy.jonsson.nyc@gmail.com
  * @license MIT
  */
(function(){function e(e){var t=r.exec(""+e.prototype.constructor),c={};return t[1].length>0&&t[1].replace(/\s/g,"").split(",").forEach(function(e,t){c[e]=t}),c}function t(e,t){return new c(e,t)}function c(e,t){this.logic=e||{},this.facts=t||{},this.process={},this.children={}}function n(){}"undefined"==typeof module?self.instinct=t:module.exports=t,t.version="1.0.0";var r=/function.*?\((.*?)\).*/;c.prototype.set=function(e,t){var c=this;c.facts[e]=t,c.children[e]&&Object.keys(c.children[e]).forEach(function(e){void 0!==c.facts[e]&&c.set(e,void 0)})},c.prototype.exec=function(t,c,r){function o(e){if(e&&(l=-1,i.process[t].apply(i,arguments)),!l--){var c=[];for(var n in a)c[a[n]]=u[n]?u[n]:i.facts[n];s.apply(u,c)}}var s,i=this;if("function"!=typeof t){if(i.facts[t])return c(null,i.facts[t]);var f=this.process[t];if(f)return i.process[t]=function(){f.apply(i,arguments),c&&c.apply(i,arguments)},i;if(s=i.logic[t],"function"!=typeof s)return void 0!==s?c(null,s):c({ref:t,err:"Not defined"})}else s=t;var a=e(s),l=0;i.process[t]=function(e,n){delete i.process[t],e||(i.facts[t]=n),e&&!e.ref&&(e={ref:t,err:e}),c&&c.call(i,e,n)};var u={};u.callback=function(){u.callback=n,i.process[t]&&i.process[t].apply(i,arguments)},u.facts=u.all=i.facts,u.success=u.resolve=function(e){u.callback(null,e)},u.error=u.reject=function(e){u.callback(e,null)},u.local=r||{};var p=a.all>-1?Object.keys(i.logic):Object.keys(a);return p.forEach(function(e){void 0!==i.facts[e]||e in u||(l++,"function"!=typeof t&&((i.children[e]||(i.children[e]={}))[t]=!0),i.exec(e,o,r))}),o(),i},c.prototype.as=function(e){var t=this;return t.process[e]=n,function(c,n){c||(t.facts[e]=n),c&&!c.ref&&(c={ref:e,err:c}),t.process[e](c,n),delete t.process[e]}}})();